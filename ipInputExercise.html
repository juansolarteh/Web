<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
  </head>
  <body>
    <label for="">Direcci贸n IP: </label>
    <input
      type="text"
      id="ip-input"
      oninput="onChangeValue()"
      style="width: 11rem"
      placeholder="_ _ _ . _ _ _ . _ _ _ . _ _ _"
    />
    <div id="error"></div>
    <button onclick="onSend()">Enviar</button>
    <script>
      const ipInput = $("#ip-input")[0];

      let length = 0;
      let byteLength = 0;
      let byteSection = 1;
      let nextPointDelete = false;
      let valid = false;

      function onChangeValue() {
        const value = ipInput.value;

        if (value.length < length) {
          if (nextPointDelete) handlePointDelete(value);
          handleCharacterDelete(ipInput.value);
          if (byteLength == 0) valid = false;
          $("#error").html("");
          return;
        }

        if (!isValidCharacter(value[value.length - 1])) {
          ipInput.value = removeLastCharacter(value);
          $("#error").html(
            "El caracter ingresado hace que no se cumpla la estructura de una direcci贸n IP."
          );
          return;
        }

        if (byteSection == 4 && byteLength == 3) {
          ipInput.value = removeLastCharacter(value);
          $("#error").html(
            "No es posible ingresar mas caracteres para una direcci贸n IP valida."
          );
          return;
        }

        $("#error").html("");

        if (value[value.length - 1] == ".") return handlePointWrite();
        handleCharacterWrite();

        if (byteLength == 0 && byteSection != 1) writePoint();

        if (byteSection == 4 && byteLength > 0) valid = true;
      }

      function onSend() {
        if (valid) console.log("enviado => ", ipInput.value);
        else $("#error").html("No es una direcci贸n IP valida");
      }

      function isValidCharacter(character) {
        return Number(character) ||
          (character == "0" && byteLength != 0) ||
          (character == "." && byteLength != 0 && byteSection != 4)
          ? true
          : false;
      }

      function removeLastCharacter(value) {
        return value.slice(0, value.length - 1);
      }

      function handleCharacterDelete(value) {
        length -= 1;
        byteLength -= 1;
        if (byteLength < 1) {
          byteLength = value.split(".")[byteSection - 1].length;
        }
        if (value[value.length - 1] == ".") nextPointDelete = true;
      }

      function handlePointDelete(value) {
        ipInput.value = removeLastCharacter(value);
        length -= 1;
        byteSection -= 1;
        nextPointDelete = false;
      }

      function handleCharacterWrite() {
        length += 1;
        byteLength += 1;
        if (byteLength == 3 && byteSection < 4) {
          byteSection += 1;
          byteLength = 0;
        }
        nextPointDelete = false;
      }

      function handlePointWrite() {
        byteSection += 1;
        length += 1;
        byteLength = 0;
        nextPointDelete = true;
      }

      function writePoint() {
        ipInput.value += ".";
        length += 1;
        nextPointDelete = true;
      }
    </script>
  </body>
</html>
